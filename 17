import { prisma } from "@/lib/prisma";
import { NextApiRequest, NextApiResponse } from "next";

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== "POST") return res.status(405).end();

  const { size, price } = req.body;
  if (!size || !price) return res.status(400).json({ error: "Missing fields" });

  const avg = await prisma.transaction.aggregate({
    _avg: { price_per_sqm: true }
  });

  const avgPrice = avg._avg.price_per_sqm ?? 0;
  const actualPrice = price / size;

  let recommendation = "Fair";
  if (actualPrice < avgPrice * 0.9) recommendation = "Profitable";
  if (actualPrice > avgPrice * 1.1) recommendation = "Overpriced";

  res.json({ recommendation, avgPrice, actualPrice });
}
